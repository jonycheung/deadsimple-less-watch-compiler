# CircleCI configuration with manual approval + version bumping releases on master
version: 2.1

parameters:
  release_with_approval:
    type: boolean
    default: false
  release_without_approval:
    type: boolean
    default: false
  release_bump:
    type: enum
    enum: [patch, minor, major]
    default: patch

defaults: &defaults
  working_directory: ~/repo
  docker:
    - image: cimg/node:24.6.0

jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - run: yarn install --frozen-lockfile --check-files
      - run:
          name: Run tests
          command: yarn test
      - persist_to_workspace:
          root: ~/repo
          paths: .

  release:
    <<: *defaults
    parameters:
      bump:
        type: enum
        enum: [patch, minor, major]
        default: patch
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Configure git user
          command: |
            git config --global user.email "ci@circle"
            git config --global user.name "circleci"
      - run:
          name: Determine next version
          command: |
            current=$(node -p "require('./package.json').version")
            bump="<< parameters.bump >>"
            next=$(BUMP=$bump CURRENT_VERSION=$current node -e 'const bump=process.env.BUMP; const current=process.env.CURRENT_VERSION; const parts=current.split(".").map(Number); if (parts.length !== 3 || parts.some((n)=>Number.isNaN(n))) { throw new Error(`Invalid version: ${current}`); } let [maj,min,patch]=parts; if (bump==="major"){maj++;min=0;patch=0;} else if (bump==="minor"){min++;patch=0;} else {patch++;} console.log(`${maj}.${min}.${patch}`);')
            echo "export NEXT_VERSION=$next" >> $BASH_ENV
      - run:
          name: Bump package.json version
          command: |
            node -e 'const fs=require("fs"); const path=require("path"); const pkgPath=path.join(process.cwd(),"package.json"); const pkg=require(pkgPath); const next=process.env.NEXT_VERSION; pkg.version=next; fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + "\n");'
      - run:
          name: Build and test
          command: |
            yarn install --frozen-lockfile --check-files
            yarn test
      - run:
          name: Commit version bump and tag
          command: |
            git add package.json yarn.lock
            git commit -m "Release $NEXT_VERSION" || echo "Nothing to commit"
            git tag v$NEXT_VERSION
      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$npm_TOKEN" > ~/repo/.npmrc
      - run:
          name: Publish package
          command: npm publish
      - run:
          name: Push commit and tag
          command: |
            git push origin HEAD
            git push origin v$NEXT_VERSION

workflows:
  version: 2

  test:
    jobs:
      - test:
          filters:
            branches:
              only:
                - master

  release_with_approval:
    when: << pipeline.parameters.release_with_approval >>
    jobs:
      - test:
          filters:
            branches:
              only:
                - master
      - approve_release:
          type: approval
          requires:
            - test
          filters:
            branches:
              only:
                - master
      - release:
          bump: << pipeline.parameters.release_bump >>
          requires:
            - approve_release
          filters:
            branches:
              only:
                - master

  release_without_approval:
    when: << pipeline.parameters.release_without_approval >>
    jobs:
      - test:
          filters:
            branches:
              only:
                - master
      - release:
          bump: << pipeline.parameters.release_bump >>
          requires:
            - test
          filters:
            branches:
              only:
                - master
